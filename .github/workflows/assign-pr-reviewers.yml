name: Assign 2 Random Reviewers on PR

on:
  pull_request:
    types: [opened]

jobs:
  assign-reviewers:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install yq and moreutils
        run: |
          sudo apt-get update
          sudo apt-get install -y yq moreutils

      - name: Assign reviewers & mention team
        env:
          PR_AUTHOR: ${{ github.actor }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ORG_NAME: bangguseok-lab
        run: |
          echo "📌 PR 작성자: $PR_AUTHOR"

          # 1. 작성자 소속 팀
          AUTHOR_TEAM=$(yq -r ".\"$PR_AUTHOR\"" user-team-map.yml)
          if [ "$AUTHOR_TEAM" = "null" ] || [ -z "$AUTHOR_TEAM" ]; then
            echo "❌ 작성자의 팀 정보를 찾을 수 없습니다."
            exit 0
          fi
          echo "👥 작성자 팀: $AUTHOR_TEAM"

          # 2. 페어 팀
          PAIR_TEAM=$(yq -r ".\"$AUTHOR_TEAM\"" team-pairs.yml)
          echo "🤝 페어 팀: $PAIR_TEAM"

          # 3. 팀원 목록 추출 (작성자 제외)
          TEAM_MEMBERS=$(yq -r 'to_entries | map(select(.value == "'"$AUTHOR_TEAM"'")) | map(.key) | .[]' user-team-map.yml)
          PAIR_MEMBERS=$(yq -r 'to_entries | map(select(.value == "'"$PAIR_TEAM"'")) | map(.key) | .[]' user-team-map.yml)

          ALL_REVIEWERS=$(echo -e "$TEAM_MEMBERS\n$PAIR_MEMBERS" | grep -v "$PR_AUTHOR" | sort -u)

          # 4. 랜덤 2명 선택
          REVIEWERS=$(echo "$ALL_REVIEWERS" | shuf | head -n 2 | tr '\n' ' ')
          echo "🎯 선택된 리뷰어: $REVIEWERS"

          # 4-1. 등록할 리뷰어가 없을 경우 방어
          if [ -z "$REVIEWERS" ]; then
            echo "⚠️ 등록할 리뷰어가 없습니다. 작성자 외 팀원이 부족하거나 잘못된 구성일 수 있습니다."
            exit 0
          fi

          # 5. 리뷰어 등록 (각각 추가)
          for REVIEWER in $REVIEWERS; do
            gh pr edit "$PR_NUMBER" --repo "$REPO" --add-reviewer "$REVIEWER"
          done

          # 6. 팀 멘션 PR 댓글 추가
          echo "🔔 @${ORG_NAME}/${AUTHOR_TEAM} 팀\nPR이 생성되었습니다. 확인 부탁드립니다 🙌\n\n작성자: @$PR_AUTHOR" > pr-comment.md

          gh pr comment "$PR_NUMBER" --repo "$REPO" --body "$(cat pr-comment.md)"

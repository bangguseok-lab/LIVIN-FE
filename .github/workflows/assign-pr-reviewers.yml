name: Assign 2 Random Reviewers on PR

on:
  pull_request:
    types: [opened]

jobs:
  assign-reviewers:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install yq and moreutils
        run: |
          sudo apt-get update
          sudo apt-get install -y yq moreutils

      - name: Assign reviewers & mention team
        env:
          PR_AUTHOR: ${{ github.actor }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ORG_NAME: bangguseok-lab
        run: |
          echo "ðŸ“Œ PR ìž‘ì„±ìž: $PR_AUTHOR"

          # 1. ìž‘ì„±ìž ì†Œì† íŒ€
          AUTHOR_TEAM=$(yq -r ".\"$PR_AUTHOR\"" user-team-map.yml)
          if [ "$AUTHOR_TEAM" = "null" ] || [ -z "$AUTHOR_TEAM" ]; then
            echo "âŒ ìž‘ì„±ìžì˜ íŒ€ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            exit 0
          fi
          echo "ðŸ‘¥ ìž‘ì„±ìž íŒ€: $AUTHOR_TEAM"

          # 2. íŽ˜ì–´ íŒ€
          PAIR_TEAM=$(yq -r ".\"$AUTHOR_TEAM\"" team-pairs.yml)
          echo "ðŸ¤ íŽ˜ì–´ íŒ€: $PAIR_TEAM"

          # 3. íŒ€ì› ëª©ë¡ ì¶”ì¶œ (ìž‘ì„±ìž ì œì™¸)
          TEAM_MEMBERS=$(yq -r 'to_entries | map(select(.value == "'"$AUTHOR_TEAM"'")) | map(.key) | .[]' user-team-map.yml)
          PAIR_MEMBERS=$(yq -r 'to_entries | map(select(.value == "'"$PAIR_TEAM"'")) | map(.key) | .[]' user-team-map.yml)

          ALL_REVIEWERS=$(echo -e "$TEAM_MEMBERS\n$PAIR_MEMBERS" | grep -v "$PR_AUTHOR" | sort -u)

          # 4. ëžœë¤ 2ëª… ì„ íƒ
          REVIEWERS=$(echo "$ALL_REVIEWERS" | shuf | head -n 2 | tr '\n' ' ')
          echo "ðŸŽ¯ ì„ íƒëœ ë¦¬ë·°ì–´: $REVIEWERS"

          # 4-1. ë“±ë¡í•  ë¦¬ë·°ì–´ê°€ ì—†ì„ ê²½ìš° ë°©ì–´
          if [ -z "$REVIEWERS" ]; then
            echo "âš ï¸ ë“±ë¡í•  ë¦¬ë·°ì–´ê°€ ì—†ìŠµë‹ˆë‹¤. ìž‘ì„±ìž ì™¸ íŒ€ì›ì´ ë¶€ì¡±í•˜ê±°ë‚˜ ìž˜ëª»ëœ êµ¬ì„±ì¼ ìˆ˜ ìžˆìŠµë‹ˆë‹¤."
            exit 0
          fi

          # 5. ë¦¬ë·°ì–´ ë“±ë¡ (ê°ê° ì¶”ê°€)
          for REVIEWER in $REVIEWERS; do
            gh pr edit "$PR_NUMBER" --repo "$REPO" --add-reviewer "$REVIEWER"
          done

          # 6. íŒ€ ë©˜ì…˜ PR ëŒ“ê¸€ ì¶”ê°€
          echo "ðŸ”” @${ORG_NAME}/${AUTHOR_TEAM} íŒ€\nPRì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. í™•ì¸ ë¶€íƒë“œë¦½ë‹ˆë‹¤ ðŸ™Œ\n\nìž‘ì„±ìž: @$PR_AUTHOR" > pr-comment.md

          gh pr comment "$PR_NUMBER" --repo "$REPO" --body "$(cat pr-comment.md)"
